pipeline {
    agent any
    environment {
        DOCKER_REGISTRY = "your-docker-registry" // e.g., "docker.io/yourusername"
        IMAGE_NAME = ""
        IMAGE_TAG = "latest"
        KUBERNETES_NAMESPACE = "edureka-igp-namespace" 
    }
    stages {
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'refs/heads/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/rakeshranade/Edureka-IGP1.git'
                    ]]
                ])
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    // Build the Docker image using the Dockerfile in the current directory
                    sh "docker build -f .docker/igp1.dockerfile -t edureka-igp1:${env.BUILD_NUMBER} ."
                }
            }
        }
        stage('Run Docker Container') {
            steps {
                script {
                    // Run the Docker container from the built image
                    sh "docker run -d -p 8097:5000 --name edureka-igp1-container edureka-igp1:${env.BUILD_NUMBER}"
                }
            }
        }
        stage('Test Docker Service') {
            steps {
                script {
                    // Assuming your Docker service is accessible at http://your-docker-service:8080
                    def dockerServiceUrl = "http://localhost:8097/privacy" 

                    // Execute curl and capture the HTTP status code
                    def httpCode = sh(
                        script: "curl --write-out '%{http_code}' --silent --output /dev/null ${dockerServiceUrl}",
                        returnStdout: true 
                    ).trim()

                    echo "HTTP Status Code for ${dockerServiceUrl}: ${httpCode}"

                    // Check if the status code indicates success (e.g., 200)
                    if (httpCode != '200') {
                        error("Docker service health check failed with status code: ${httpCode}")
                    } else {
                        echo "Docker service is healthy."
                    }
                }
            }
        }
        stage('stop and clean Docker Container') {
            steps {
                script {
                    // stop container
                    sh "docker stop edureka-igp1-container"

                    sh "docker rm edureka-igp1-container"

                }
            }
        }
        stage('Push Docker Image') {
            steps {
                script {
                    // Log in to Docker Hub
                    withCredentials([usernamePassword(credentialsId: '777', usernameVariable: 'DOCKERHUB_USERNAME', passwordVariable: 'DOCKERHUB_PASSWORD')]) {
                        sh "echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin"
                    
                        // Push the Docker image to Docker Hub
                        sh "docker tag edureka-igp1:${env.BUILD_NUMBER} $DOCKERHUB_USERNAME/edureka-igp:${env.BUILD_NUMBER}"
                        sh "docker push $DOCKERHUB_USERNAME/edureka-igp:${env.BUILD_NUMBER}"
                        IMAGE_NAME = "$DOCKERHUB_USERNAME/edureka-igp"
                    }
                }
            }
        }
        stage('Deploy to MicroK8s') {
            steps {
                script {
                    sh "microk8s kubectl apply -f ./jenkins/.kubernetes/deployment.yaml -n ${KUBERNETES_NAMESPACE}"
                    sh "microk8s kubectl apply -f ./jenkins/.kubernetes/service.yaml -n ${KUBERNETES_NAMESPACE}"
                }
            }
        }
    }
}